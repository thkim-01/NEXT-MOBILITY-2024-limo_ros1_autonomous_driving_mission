# Limo Autonomous Controller - 다이어그램

## 시스템 아키텍처

```
┌─────────────────────────────────────────────────────────────┐
│                    Limo Pro Robot                            │
├─────────────────────────────────────────────────────────────┤
│                                                               │
│  ┌──────────┐        ┌──────────┐       ┌──────────┐       │
│  │  Camera  │        │  LiDAR   │       │   V2X    │       │
│  │          │        │          │       │ Receiver │       │
│  └────┬─────┘        └────┬─────┘       └────┬─────┘       │
│       │                   │                   │             │
│       │ CompressedImage   │ LaserScan         │ String      │
│       │                   │                   │             │
│       └───────────────────┴───────────────────┘             │
│                           │                                 │
│                           v                                 │
│       ┌───────────────────────────────────────┐             │
│       │   Combined Controller Node            │             │
│       │                                        │             │
│       │  ┌──────────────────────────────────┐ │             │
│       │  │  Lane Detection                  │ │             │
│       │  │  - HSV Color Filtering           │ │             │
│       │  │  - Yellow/White Line Detection   │ │             │
│       │  └──────────────────────────────────┘ │             │
│       │                                        │             │
│       │  ┌──────────────────────────────────┐ │             │
│       │  │  Obstacle Detection              │ │             │
│       │  │  - 45° LiDAR Scan                │ │             │
│       │  │  - Distance Thresholding         │ │             │
│       │  └──────────────────────────────────┘ │             │
│       │                                        │             │
│       │  ┌──────────────────────────────────┐ │             │
│       │  │  Decision Logic                  │ │             │
│       │  │  1. Obstacle Avoidance           │ │             │
│       │  │  2. Lane Following               │ │             │
│       │  │  3. V2X Command Execution        │ │             │
│       │  │  4. Search Mode                  │ │             │
│       │  └──────────────────────────────────┘ │             │
│       └────────────────┬──────────────────────┘             │
│                        │                                     │
│                        │ Twist (cmd_vel)                     │
│                        v                                     │
│                 ┌──────────────┐                             │
│                 │ Motor Driver │                             │
│                 └──────────────┘                             │
│                                                               │
└─────────────────────────────────────────────────────────────┘
```

## 제어 흐름도

```
START
  │
  ├─> [Camera Callback] ──> 이미지 저장
  │
  ├─> [LiDAR Callback] ──> 스캔 데이터 저장
  │
  ├─> [V2X Callback] ──> 경로 명령 저장
  │
  └─> [Control Loop @ 20Hz]
        │
        ├─> detect_obstacle()
        │     │
        │     ├─ 장애물 있음?
        │     │   └─> YES: 회피 방향 계산
        │     │   └─> NO: 계속
        │
        ├─> detect_lane()
        │     │
        │     ├─ HSV 색상 필터링
        │     ├─ 히스토그램 분석
        │     └─ 차선 중심 계산
        │
        └─> Decision Making
              │
              ├─ [1순위] 장애물 감지?
              │   └─> YES: 회피 기동
              │
              ├─ [2순위] 차선 감지?
              │   └─> YES: 차선 추종
              │
              ├─ [3순위] V2X 명령?
              │   └─> YES: 명령 실행 (A/B/C)
              │
              └─ [4순위] 기본 동작
                  └─> 차선 탐색 모드
                  
              │
              └─> /cmd_vel 발행
                    │
                    └─> [다음 반복]
```

## 토픽 관계도

```
                    ┌─────────────────────────┐
                    │  External V2X System    │
                    └───────────┬─────────────┘
                                │
                        /path_ (String)
                                │
    ┌───────────────────────────┼───────────────────────────┐
    │                           v                           │
    │              ┌─────────────────────────┐              │
    │              │   combined_controller   │              │
    │              │         _node           │              │
    │              └─────────────────────────┘              │
    │                      ^   ^   │                        │
    │                      │   │   │                        │
    │    /camera/rgb/      │   │   │    /cmd_vel           │
    │    image_raw/        │   │   └─────────────>          │
    │    compressed        │   │           (Twist)          │
    │   (CompressedImage)  │   │                            │
    │                      │   │                            │
    │                      │   └──────────                  │
    │                      │           /scan                │
    │                      │       (LaserScan)              │
    │                      │                                │
    └──────────────────────┼────────────────────────────────┘
                           │
                    Camera Driver
                    LiDAR Driver
```

## 우선순위 결정 로직

```
┌─────────────────────────────────────┐
│     장애물 감지?                       │
│  (거리 < 39cm, 각도 ±45°)             │
└──────────┬──────────────────────────┘
           │
      YES  │  NO
           │
    ┌──────v──────┐
    │ 장애물 회피   │
    │   모드       │
    │             │         ┌────────────────────┐
    │ - 속도 감소  │         │   차선 감지됨?      │
    │ - 회피 조향  │         │                    │
    └─────────────┘         └──────┬─────────────┘
                                   │
                              YES  │  NO
                                   │
                            ┌──────v──────┐
                            │ 차선 추종    │
                            │   모드       │
                            │             │      ┌─────────────────┐
                            │ - 중심 계산  │      │  V2X 명령 있음?  │
                            │ - PD 제어   │      │                 │
                            └─────────────┘      └────┬────────────┘
                                                      │
                                                 YES  │  NO
                                                      │
                                               ┌──────v───────┐
                                               │  V2X 모드     │
                                               │              │
                                               │ A: 좌회전    │      ┌──────────────┐
                                               │ B: 직진      │      │   탐색 모드   │
                                               │ C: 우회전    │      │              │
                                               └──────────────┘      │ - 저속 주행  │
                                                                     │ - 좌회전     │
                                                                     └──────────────┘
```

## 파라미터 목록

| 파라미터 | 기본값 | 단위 | 설명 |
|---------|--------|------|------|
| default_speed | 0.25 | m/s | 차선 추종 시 기본 속도 |
| obstacle_speed | 0.15 | m/s | 장애물 회피 시 속도 |
| search_speed | 0.18 | m/s | 차선 탐색 시 속도 |
| scan_degree | 45 | ° | LiDAR 스캔 각도 범위 |
| min_dist | 0.39 | m | 장애물 감지 최소 거리 |
| angle_resolution | π/640 | rad | 조향 각도 해상도 |
